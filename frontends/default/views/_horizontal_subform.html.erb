<table cellpadding="0" cellspacing="0">
  <%
  begin
    controller = active_scaffold_controller_for(column.association.klass).new
    controller.instance_variable_set(:@_request, request) # provide the session for nesting purposes
    @record = controller.send(:new_model)
  rescue ActiveScaffold::ControllerNotFound
    @record = column.association.klass.new
  end
  -%>
  <%= render :partial => 'horizontal_subform_header', :locals => {:parent_record => parent_record} %>

  <tbody id="<%= sub_form_list_id(:association => column.name) %>">
    <% associated.each_index do |index| %>
    <% @record = associated[index] -%>
    <% if @record.errors.count -%>
    <tr class="association-record-errors">
      <td colspan="<%= active_scaffold_config_for(@record.class).subform.columns.length + 1 %>" id="<%= element_messages_id :action => @record.class.name.underscore, :id => "#{parent_record.id}-#{index}" %>">
        <%= active_scaffold_error_messages_for :record, :object_name => @record.class.model_name.human.downcase %>
      </td>
    </tr>
    <% end %>
    <%= render :partial => 'horizontal_subform_record', :locals => {:scope => column_scope(column), :parent_record => parent_record, :column => column, :locked => @record.new_record? && @record == associated.last} %>
    <% end -%>
  </tbody>
</table>
<%= render :partial => 'form_association_footer', :locals => {:parent_record => parent_record, :column => column, :associated => associated} -%>
